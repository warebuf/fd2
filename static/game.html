<html lang="en">
<head>
    <title>.</title>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }
        body {
            height:100%;
            margin: 0;
            overflow: hidden;

        }
        #container {
            position:relative;
        }
        #test {
            position: absolute;
            padding: 0px;
            text-align: center;
            max-width: 100%;
            width: 100%;
            margin-left:auto;
            margin-right:auto;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
        }
        #sel_but {
            padding: 0px;
            text-align: center;

            position: absolute;
            right: 10px;
            top: 10px;
        }

    </style>
</head>


<body>

<div id="container">

    <div id="sel_but"></div>
    <div id="test"> </div>

    <canvas id="myCanvas"></canvas>

</div>



<script src="https://cdn.socket.io/socket.io-3.0.5.js"></script>
<script src="/static/engine.js"></script>

<script type="text/javascript">
    sourceURL="test.js"

    document.onkeydown = function (e) {

        switch (e.key) {
            case "ArrowLeft":
                console.log("ArrowLeft")
                break;
            case "ArrowRight":
                console.log("ArrowRight")
                break;
            case "ArrowUp":
                console.log("ArrowUp")
                if(match_data.length>0){

                    // begin iterating through all the heros, check if the hero is at Position 0,
                    // if he is, then break, otherwise keep iterating until you do a full rotation
                    found = false;
                    for(i=0;i<state.length;i++) {
                        for(j=0;j<state[i].length;j++) {
                            for(k=0;k<state[i][j].length;k++) {
                                indexer_b--
                                if(indexer_b<0){
                                    indexer_b=4;
                                    indexer_u--;
                                    if(indexer_u<0) {
                                        indexer_u=state[0].length-1;
                                        indexer_t--;
                                        if(indexer_t<0) {
                                            indexer_t=state.length-1
                                        }
                                    }
                                }

                                if(state[indexer_t][indexer_u][indexer_b].Position==0){
                                    found=true
                                    break
                                }
                            }
                            if(found==true){
                                break
                            }
                        }
                        if(found==true){
                            break
                        }
                    }
                }
                break;
            case "ArrowDown":
                console.log("ArrowDown")
                if(match_data.length>0){

                    found = false;
                    for(i=0;i<state.length;i++) {
                        for(j=0;j<state[0].length;j++) {
                            for(k=0;k<state[0][0].length;k++) {
                                indexer_b++
                                if(indexer_b>=5){
                                    indexer_b=0;
                                    indexer_u++;
                                    if(indexer_u>=state[0].length) {
                                        indexer_u=0;
                                        indexer_t++;
                                        if(indexer_t>=state.length) {
                                            indexer_t=0
                                        }
                                    }
                                }

                                if(state[indexer_t][indexer_u][indexer_b].Position==0){
                                    found=true
                                    break
                                }
                            }
                            if(found==true){
                                break
                            }
                        }
                        if(found==true){
                            break
                        }
                    }
                }
                break;
            case 'W':
            case 'w':
                console.log('w')
                if(
                    game_over == false &&
                    match_data.length > 0 &&
                    turn.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    state[indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'HEAD', "Team_index": my_team, "Client_index": my_int, "Hero_index": indexer_b }))

                    found = false;
                    for(i=0;i<match_data[0].length;i++) {
                        for(j=0;j<match_data[0][0].length;j++) {
                            for(k=0;k<match_data[0][0][0].length;k++) {
                                indexer_b++
                                if(indexer_b>=5){
                                    indexer_b=0;
                                    indexer_u++;
                                    if(indexer_u>=match_data[0][0].length) {
                                        indexer_u=0;
                                        indexer_t++;
                                        if(indexer_t>=match_data[0].length) {
                                            indexer_t=0
                                        }
                                    }
                                }

                                if((my_team==indexer_t) && (my_int==indexer_u) && state[indexer_t][indexer_u][indexer_b].Position==0){
                                    found=true
                                    break
                                }
                            }
                            if(found==true){
                                break
                            }
                        }
                        if(found==true){
                            break
                        }
                    }
                }
                break;
            case 'A':
            case 'a':
                console.log('a')
                if(
                    game_over == false &&
                    match_data.length > 0 &&
                    turn.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    state[indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'LARM', "Team_index": my_team, "Client_index": my_int, "Hero_index": indexer_b }))

                    found = false;
                    for(i=0;i<match_data[0].length;i++) {
                        for(j=0;j<match_data[0][0].length;j++) {
                            for(k=0;k<match_data[0][0][0].length;k++) {
                                indexer_b++
                                if(indexer_b>=5){
                                    indexer_b=0;
                                    indexer_u++;
                                    if(indexer_u>=match_data[0][0].length) {
                                        indexer_u=0;
                                        indexer_t++;
                                        if(indexer_t>=match_data[0].length) {
                                            indexer_t=0
                                        }
                                    }
                                }

                                if((my_team==indexer_t) && (my_int==indexer_u) && state[indexer_t][indexer_u][indexer_b].Position==0){
                                    found=true
                                    break
                                }
                            }
                            if(found==true){
                                break
                            }
                        }
                        if(found==true){
                            break
                        }
                    }
                }
                break;
            case 'S':
            case 's':
                console.log('s')
                if(
                    game_over == false &&
                    match_data.length > 0 &&
                    turn.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    state[indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'BOTTOM', "Team_index": my_team, "Client_index": my_int, "Hero_index": indexer_b }))

                    found = false;
                    for(i=0;i<match_data[0].length;i++) {
                        for(j=0;j<match_data[0][0].length;j++) {
                            for(k=0;k<match_data[0][0][0].length;k++) {
                                indexer_b++
                                if(indexer_b>=5){
                                    indexer_b=0;
                                    indexer_u++;
                                    if(indexer_u>=match_data[0][0].length) {
                                        indexer_u=0;
                                        indexer_t++;
                                        if(indexer_t>=match_data[0].length) {
                                            indexer_t=0
                                        }
                                    }
                                }

                                if((my_team==indexer_t) && (my_int==indexer_u) && state[indexer_t][indexer_u][indexer_b].Position==0){
                                    found=true
                                    break
                                }
                            }
                            if(found==true){
                                break
                            }
                        }
                        if(found==true){
                            break
                        }
                    }
                }
                break;
            case 'D':
            case 'd':
                console.log('d')
                if(
                    game_over == false &&
                    match_data.length > 0 &&
                    turn.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    state[indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'RARM', "Team_index": my_team, "Client_index": my_int, "Hero_index": indexer_b }))

                    found = false;
                    for(i=0;i<match_data[0].length;i++) {
                        for(j=0;j<match_data[0][0].length;j++) {
                            for(k=0;k<match_data[0][0][0].length;k++) {
                                indexer_b++
                                if(indexer_b>=5){
                                    indexer_b=0;
                                    indexer_u++;
                                    if(indexer_u>=match_data[0][0].length) {
                                        indexer_u=0;
                                        indexer_t++;
                                        if(indexer_t>=match_data[0].length) {
                                            indexer_t=0
                                        }
                                    }
                                }

                                if((my_team==indexer_t) && (my_int==indexer_u) && state[indexer_t][indexer_u][indexer_b].Position==0){
                                    found=true
                                    break
                                }
                            }
                            if(found==true){
                                break
                            }
                        }
                        if(found==true){
                            break
                        }
                    }
                }
                break
            case ' ':
                if(game_over==true) {
                    returntomatchmaking()
                }
                break;
        }

    }

    // important data
    var socket = null; // socket object for this tab
    var my_team = -1; // the user's team index
    var my_int = -1; // the user's player index

    // pointer index
    var indexer_t = 0;
    var indexer_u = 0;
    var indexer_b = 0;

    // state stuff
    var animating_state = -1 // where are we at in the dataset
    var phase = "null";
    var turn = "null"; // the current phase/turn
    var sent_time = null; // the time that the turn ends

    var game_over = false;

    // global variables to help simulation
    var all_up_to_date = true
    var pos_up_to_date = true
    var act_up_to_date = true

    var draw_attacks = false

    // the board state
    var state = []

    // datasets
    var match_data = new Array();
    var atk_data = new Array();

    var time_queue = []
    var turn_queue = []

    var event_log = []

    var total_units_of_time = 0;


    function test() {

        if (!window["WebSocket"]) {
            alert("Error: Your browser does not support web sockets.")
        } else {
            socket = new WebSocket("ws://{{.host}}/msocket?matchid={{.mid}}");
            socket.onclose = function() {
                alert("Connection has been closed.");
            }

            socket.onmessage = function(e) {
                var receive_time = Date.now()
                var msg = eval('('+e.data+')');
                console.log(msg.Event, msg.Name, msg.MatchID, msg.Message, msg.TCH, msg.Turn);

                var msg_date = msg.When.substring(0,10);
                var msg_time = msg.When.substring(11,19);

                if(msg.Event == 'clockSyncRequest') {
                    console.log("dif", Date.parse(msg.When) - receive_time)
                    socket.send(JSON.stringify({ "Event": 'clockSyncResponse', "Message": receive_time.toString() }))
                }
                else if(msg.Event == 'entered') {
                    event_log.push(msg_date + ' ' + msg_time + ' ' + msg.Name + ' has entered the game')
                    if(event_log.length >= 25) {
                        event_log.shift()
                    }
                }
                else if(msg.Event == 'left') {
                    event_log.push(msg_date + ' ' + msg_time + ' ' + msg.Name + ' has left the game')
                    if(event_log.length >= 25) {
                        event_log.shift()
                    }
                }
                else if(msg.Event == 'unitsOfTime') {
                    time_queue.push(parseFloat(msg.Message).toFixed(3))
                }
                else if(msg.Event == 'ticker_start') {
                    sent_time = Date.parse(msg.Message)
                }
                else if(msg.Event == 'update_phase') {
                    if (phase=="null") {
                        phase = msg.Phase
                        if(phase="CHARACTER SELECTION") {
                            console.log(document.getElementById("sel_but"))
                            document.getElementById("sel_but").insertAdjacentHTML('beforeend',"<button id='a1' onclick=endCharSelect()>finished</button>");
                        }
                    } else {
                        if(phase=="CHARACTER SELECTION") {
                            var menu2 = document.getElementById("sel_but");
                            menu2.remove();
                        }
                        phase_queue.push(msg.Phase)
                    }
                }
                else if(msg.Event == 'game_state') {
                    console.log("received game_state")

                    turn_queue.push(msg.Turn)

                    // turn the JSON into javascript objects
                    let temp = msg.TCH;
                    let md = [];
                    for (i = 0; i < temp.length; i++) {
                        md[i] = new Array();
                        for (j = 0; j < temp[i].length; j++) {
                            md[i][j] = new Array();
                            for (k = 0; k < temp[i][j].length; k++ ){
                                md[i][j][k] = JSON.parse(temp[i][j][k]);
                            }
                        }
                    }
                    // if this is the first game_state received, init all global variables
                    all_up_to_date = false
                    pos_up_to_date = false
                    act_up_to_date = false

                    if(animating_state == -1) {
                        let temp_string = msg.Message.split(";")
                        my_team = parseInt(temp_string[0])
                        my_int = parseInt(temp_string[1])
                        indexer_t = my_team
                        indexer_u = my_int
                        state = md;
                        animating_state = 0
                    }

                    match_data.push(md)
                    //printAllMatchData(match_data)
                    //console.log(match_data)

                    console.log("atk_data",msg.Atk)
                    if(msg.Atk == null) {
                        atk_data.push([])
                    } else {
                        atk_data.push(msg.Atk)
                        /*
                        weights = msg.Atk[0].attacker[0].split(';')
                        sum = Number(weights[2])+Number(weights[3])+Number(weights[4])+Number(weights[5])
                        partper = weights[0]+weights[1]
                        hweight = Math.round(100*Number(weights[2])/sum).toString() + '%'
                        lweight = Math.round(100*Number(weights[3])/sum).toString() + '%'
                        rweight = Math.round(100*Number(weights[4])/sum).toString() + '%'
                        bweight = Math.round(100*Number(weights[5])/sum).toString() + '%'

                        let s = msg.Attacker[0] + ',' + msg.Attacker[1] + ',' + msg.Attacker[2] + ' attacked '
                            +msg.Defender[0][0] + ',' + msg.Defender[0][1] + ',' +msg.Defender[0][2] + ' '
                            +partper +' (H'+hweight+' L'+lweight+' R'+rweight+' B'+bweight+')'
                         */
                    }

                }
                else if(msg.Event == 'game_over') {
                    game_over = true
                    document.getElementById("test").insertAdjacentHTML('beforeend',"<button id='b1' onclick=returntomatchmaking()>RETURN TO MATCHMAKING</button>");
                }
            }
        }
    }
    test()

function returntomatchmaking(){
    window.location.href = 'http://{{.host}}/waitroom'
}

function endCharSelect(){
    socket.send(JSON.stringify({ "Event": 'endCharSel' }))
}

</script>
</body>
</html>
