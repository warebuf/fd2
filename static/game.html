<html lang="en">
<head>
    <title>.</title>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }
        body {
            height:100%;
            margin: 0;
            overflow: hidden;
        }

        #container {
            position:relative;
        }

        #messages {
            position: absolute;
            padding: 0px;
            text-align: center;
            max-width: 100%;
            width: 100%;
            margin-left:auto;
            margin-right:auto;
            top:60%;
            left:50%;
            transform:translate(-50%,-50%);
        }

    </style>
</head>


<body>

<div id="container">

    <canvas id="myCanvas"></canvas>

</div>



<script src="https://cdn.socket.io/socket.io-3.0.5.js"></script>
<script src="/static/engine.js"></script>

<script>
    document.onkeydown = function (e) {

        switch (e.key) {
            case "ArrowLeft":
                console.log("l")
                break;
            case "ArrowRight":
                console.log("r")
                break;
            case "ArrowUp":
                console.log("u")
                if(match_data.length>0){
                    indexer_b--;
                    if(indexer_b<0){
                        indexer_b=4
                        indexer_u--
                        if(indexer_u<0) {
                            indexer_u = match_data[0][0].length-1
                            indexer_t--
                            if (indexer_t<0) {
                                indexer_t=match_data[0].length-1
                            }
                        }
                    }
                }
                break;
            case "ArrowDown":
                console.log("d")
                if(match_data.length>0){
                    indexer_b++;
                    if(indexer_b>=5){
                        indexer_b=0
                        indexer_u++
                        if(indexer_u>=match_data[0][0].length) {
                            indexer_u = 0
                            indexer_t++
                            if (indexer_t >= match_data[0].length) {
                                indexer_t=0
                            }
                        }
                    }
                }
                break;
            case 'w':
                console.log('w')
                if(
                    match_data.length > 0 &&
                    status.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    match_data[current_state][indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'UP' }))
                }
                break;
            case 'a':
                console.log('a')
                if(
                    match_data.length > 0 &&
                    status.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    match_data[current_state][indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'LEFT' }))
                }
                break;
            case 's':
                console.log('s')
                if(
                    match_data.length > 0 &&
                    status.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    match_data[current_state][indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'DOWN' }))
                }
                break;
            case 'd':
                console.log('d')
                if(
                    match_data.length > 0 &&
                    status.substring(0,4) == "TURN" &&
                    indexer_t == my_team &&
                    indexer_u == my_int &&
                    match_data[current_state][indexer_t][indexer_u][indexer_b].Position == 0
                ) {
                    socket.send(JSON.stringify({ "Event": 'act', "Message": 'RIGHT' }))
                }
                break
        }

    }

    var socket = null;
    var startCount = null;
    var match_data = new Array();
    var current_state = -1;
    var my_team = -1;
    var my_int = -1;
    var status = "null";

    var indexer_t = 0;
    var indexer_u = 0;
    var indexer_b = 0;

    function test() {

        var messages = document.getElementById("messages")

        if (!window["WebSocket"]) {
            alert("Error: Your browser does not support web sockets.")
        } else {
            socket = new WebSocket("ws://{{.host}}/ingame?matchid={{.mid}}");
            socket.onclose = function() {
                alert("Connection has been closed.");
            }

            socket.onmessage = function(e) {
                var receive_time = Date.now()
                var msg = eval('('+e.data+')');
                console.log(msg.Event, msg.Name, msg.MatchID, msg.Message, msg.TCH);

                var msg_date = msg.When.substring(0,10);
                var msg_time = msg.When.substring(11,19);

                if(msg.Event == 'clockSyncRequest') {
                    console.log("dif", Date.parse(msg.When) - receive_time)
                    socket.send(JSON.stringify({ "Event": 'clockSyncResponse', "Message": receive_time.toString() }))
                }
                else if(msg.Event == 'entered') {
                    console.log(msg_date + ' ' + msg_time + ' ' + msg.Name + ' has entered the game')
                }
                else if(msg.Event == 'left') {
                    console.log(msg_date + ' ' + msg_time + ' ' + msg.Name + ' has left the game')
                }
                else if(msg.Event == 'startMatchCountdown') {
                    startCount = Date.parse(msg.Message)
                    once = true
                    status = msg.Status
                }
                else if(msg.Event == 'turn') {
                    startCount = Date.parse(msg.Message)
                }
                else if(msg.Event == 'game_state') {
                    status = msg.Status
                    
                    var temp_string = msg.Message.split(";")
                    my_team = parseInt(temp_string[0])
                    my_int = parseInt(temp_string[1])

                    var temp = msg.TCH;
                    var md = new Array();
                    for (i = 0; i < temp.length; i++) {
                        md[i] = new Array();
                        for (j = 0; j < temp[i].length; j++) {
                            md[i][j] = new Array();
                            for (k = 0; k < temp[i][j].length; k++ ){
                                md[i][j][k] = JSON.parse(temp[i][j][k]);
                            }
                        }
                    }

                    match_data.push(md)
                    console.log(match_data)
                    current_state = match_data.length-1

                }
            }
        }
    }
    test()




</script>
</body>
</html>
